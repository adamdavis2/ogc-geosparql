= Annex D - Usage of SHACL shapes (informative)

== D.0 Overview

This Annex provides guidance on the usage of the SHACL shapes shipped with the GeoSPARQL specification. 

The Shape Constraint Language https://www.w3.org/TR/shacl/[SHACL] allows to specify constraints on RDF data, phrased as a set of conditions modeled in shape graphs.

In the GeoSPARQL standard we define SHACL shapes in such a way that they validate teh anticipated graph structure defined by the requirements defined in the standard specification. In this way, users may validate a given RDF document against this shape graphs to correct mistakes in their data model.

== D.1 Foundations

https://github.com/opengeospatial/ogc-geosparql/blob/master/1.1/validator.ttl[SHACL shapes provided with GeoSPARQL] are used to verify the graph structure of GeoSPARQL graphs. 
There are several SHACL verification tools that one might consider using to validate their graph.

https://github.com/RDFLib/pySHACL[PySHACL] is a python implementation based on RDFlib which is able to validate graphs.

https://jena.apache.org/documentation/shacl/index.html[Apache Jena SHACL] might be used to validate graphs as well.

The previous implementations require to load the SHACL shape set of GeoSPARQL and the graph to be tested. A test result will be generated which describes the success or failure of predefined tests encoded in the GeoSPARQL SHACL shapes.

In addition, SHACL is part of many triple store implementations such as https://www.ontotext.com/products/graphdb/[GraphDB], https://rdf4j.org[RDF4J] and https://jena.apache.org/documentation/fuseki2/[Apache Jena Fuseki], which may also be used for graph verification.

The following sections elaborate on the kind of shapes and their purposes.

== D.2 Scope of SHACL shapes provided with GeoSPARQL

The SHACL shapes defined in the GeoSPARQL 1.1 standard all target the verification of specific graph structures, but except very few cases do not validate the content of literal types.
In particular, the following attributes of the graph are validated:

* *Proper usage of GeoSPARQL classes*: These shapes check for a proper usage of instances of GeoSPARQL classes. For example, we check that instances of collection classes should at least have one element and that instances of Geometry classes should at least have one serilization to avoid creating graphs which contain nodes without necessary information.
* *Geometry property consistency*: Certain checks are applied for properties describing geometries. For example we check dimensionality properties for corresponding values
* *Rudimentary checks of literal contents*: The SHACL shapes defined in this standard do not substitute a verification of literal contents by validators of the respective data formats. However, they define checks using regular expressions to detect a falsely formatted geospatial literal. For example, if a GeoJSON literal is declared using its literal type, a SHACL shape will check for curly brackets to be present (as they are part of the JSON specification)

== D.3 Table of SHACL shapes

[cols="1,1,1,1"]
|===
|SHACL Shape ID | Severity | Test purpose | Requirements tested 

|http://www.opengis.net/def/geosparql/validator/S1-a-hasGeometry-hasSerialization-sub[Shape 1a]
| Violation
| Each node with an incoming http://www.opengis.net/ont/geosparql#hasGeometry[geo:hasGeometry], or a specialization of it, should have minimum one outgoing relation that is either http://www.opengis.net/ont/geosparql#hasSerialization[geo:hasSerialization], or a specialization of it.
| <<req_geometry-extension_feature_properties>>, <<req_geometry-extension_geometry_properties>>

|http://www.opengis.net/def/geosparql/validator/S1-b-hasGeometry-hasSerialization-sub[Shape 1b]
| Warning
| Tests for many serializations attached to one instances of http://www.opengis.net/ont/geosparql#Geometry[geo:Geometry]. It is recommended, that only one serialization is attached to a Geometry. If not, the user should ensure, that the serializations are equivalent.
| <<req_geometry-extension_geometry_properties>>

|http://www.opengis.net/def/geosparql/validator/S1-c-hasGeometry-hasSerialization-sub[Shape 1c]
| Violation
| Each node with an incoming http://www.opengis.net/ont/geosparql#hasGeometry[geo:hasGeometry], or a specialization of it, can have a maximum of one outgoing http://www.opengis.net/ont/geosparql#asWKT[geo:asWKT] relation.
| 

|http://www.opengis.net/def/geosparql/validator/S1-d-hasGeometry-hasSerialization-sub[Shape 1d]
| Violation
| Each node with an incoming http://www.opengis.net/ont/geosparql#hasGeometry[geo:hasGeometry], or a specialization of it, can have a maximum of one outgoing http://www.opengis.net/ont/geosparql#asGML[geo:asGML] relation.
| 

|http://www.opengis.net/def/geosparql/validator/S1-e-hasGeometry-hasSerialization-sub[Shape 1e]
| Violation 
| Each node with an incoming http://www.opengis.net/ont/geosparql#hasGeometry[geo:hasGeometry], or a specialization of it, can have a maximum of one outgoing  http://www.opengis.net/ont/geosparql#asGeoJSON[geo:asGeoJSON]  relation.
| 

|http://www.opengis.net/def/geosparql/validator/S1-f-hasGeometry-hasSerialization-sub[Shape 1f]
| Violation
| Each node with an incoming http://www.opengis.net/ont/geosparql#hasGeometry[geo:hasGeometry], or a specialization of it, can have a maximum of one outgoing http://www.opengis.net/ont/geosparql#asKML[geo:asKML] relation.
| 

|http://www.opengis.net/def/geosparql/validator/S2-hasSerialization-hasGeometry[Shape 2]
| Violation
| Each node with one or more outgoing relations that are either http://www.opengis.net/ont/geosparql#hasSerialization[geo:hasSerialization], or a specialization of it, should have at least one incoming http://www.opengis.net/ont/geosparql#hasGeometry[geo:hasGeometry] relation or a specialization of it.
| 

|http://www.opengis.net/def/geosparql/validator/S3-hasGeometry-hasGeometry[Shape 3a-c]
| Violation
| A node that has an incoming http://www.opengis.net/ont/geosparql#hasGeometry[geo:hasGeometry] property, or specialization of it, cannot have an outgoing http://www.opengis.net/ont/geosparql#hasGeometry[geo:hasGeometry] property, or a specialization of, it at the same time (a http://www.opengis.net/ont/geosparql#Feature[geo:Feature] cannot be a http://www.opengis.net/ont/geosparql#Geometry[geo:Geometry] at the same time)
| 

|http://www.opengis.net/def/geosparql/validator/S4-hasSerialization-literal[Shape 4]
| Violation
| The target of a http://www.opengis.net/ont/geosparql#hasSerialization[geo:hasSerialization] property, or a specialization of, it should be an RDF literal
| 

|http://www.opengis.net/def/geosparql/validator/S5-asWKT-wktLiteral[Shape 5]
| Violation
| The target of a http://www.opengis.net/ont/geosparql#asWKT[geo:asWKT] property should be an RDF literal with datatype http://www.opengis.net/ont/geosparql#wktLiteral[geo:wktLiteral]
| 

|http://www.opengis.net/def/geosparql/validator/S6-asGML-gmlLiteral[Shape 6]
| Violation
| The target of a http://www.opengis.net/ont/geosparql#asGML[geo:asGML] property should be an RDF literal with datatype http://www.opengis.net/ont/geosparql#gmlLiteral[geo:gmlLiteral]
| 

|http://www.opengis.net/def/geosparql/validator/S7-asGeoJSON-geoJSONLiteral[Shape 7]
| Violation
| The target of a http://www.opengis.net/ont/geosparql#asGeoJSON[geo:asGeoJSON] property should be an RDF literal with datatype http://www.opengis.net/ont/geosparql#geoJSONLiteral[geo:geoJSONLiteral]
| 

|http://www.opengis.net/def/geosparql/validator/S8-asKML-kmlLiteral[Shape 8]
| Violation
| The target of a http://www.opengis.net/ont/geosparql#asKML[geo:asKML] property should be an RDF literal with datatype http://www.opengis.net/ont/geosparql#kmlLiteral[geo:kmlLiteral]
| 

|http://www.opengis.net/def/geosparql/validator/S10-many-coordinateDimension-one[Shape 10]
| Violation
| A http://www.opengis.net/ont/geosparql#Geometry[geo:Geometry] node should have maximum of one outgoing http://www.opengis.net/ont/geosparql#coordinateDimension[geo:coordinateDimension] property
| 

|http://www.opengis.net/def/geosparql/validator/S11-many-dimension-one[Shape 11]
| Violation
| A http://www.opengis.net/ont/geosparql#Geometry[geo:Geometry] node should have maximum of one outgoing http://www.opengis.net/ont/geosparql#dimension[geo:dimension] property
| 

|http://www.opengis.net/def/geosparql/validator/S12-many-isEmpty-one[Shape 12]
| Violation
| A http://www.opengis.net/ont/geosparql#Geometry[geo:Geometry] node should have maximum of one outgoing http://www.opengis.net/ont/geosparql#isEmpty[geo:isEmpty] property
| 

|http://www.opengis.net/def/geosparql/validator/S13-many-isSimple-one[Shape 13]
| Violation
| A http://www.opengis.net/ont/geosparql#Geometry[geo:Geometry] node should have a maximum one outgoing http://www.opengis.net/ont/geosparql#isSimple[geo:isSimple] property
| 

|http://www.opengis.net/def/geosparql/validator/S14-many-spatialDimension-one[Shape 14]
| Violation
| A http://www.opengis.net/ont/geosparql#Geometry[geo:Geometry] node should have maximum of one outgoing http://www.opengis.net/ont/geosparql#spatialDimension[geo:spatialDimension] property
| 

|http://www.opengis.net/def/geosparql/validator/S15a-many-hasSpatialResolution-one[Shape 15a]
| Violation
| A http://www.opengis.net/ont/geosparql#Geometry[geo:Geometry] node should have maximum of one outgoing http://www.opengis.net/ont/geosparql#hasSpatialResolution[geo:hasSpatialResolution] property
| 

|http://www.opengis.net/def/geosparql/validator/S15b-many-hasSpatialAccuracy-one[Shape 15b]
| Violation
| A http://www.opengis.net/ont/geosparql#Geometry[geo:Geometry] node should have maximum of one outgoing http://www.opengis.net/ont/geosparql#hasSpatialAccuracy[geo:hasSpatialAccuracy] property
| 

|http://www.opengis.net/def/geosparql/validator/S15c-many-hasMetricAccuracy-one[Shape 15c]
| Violation
| A http://www.opengis.net/ont/geosparql#Geometry[geo:Geometry] node should have maximum of one outgoing http://www.opengis.net/ont/geosparql#hasMetricAccuracy[geo:hasMetricAccuracy] property
| 

|http://www.opengis.net/def/geosparql/validator/S15d-many-hasMetricResolution-one[Shape 15d]
| Violation
| A http://www.opengis.net/ont/geosparql#Geometry[geo:Geometry] node should have maximum of one outgoing http://www.opengis.net/ont/geosparql#hasMetricResolution[geo:hasMetricResolution] property
| 

|http://www.opengis.net/def/geosparql/validator/S16-wkt-content[Shape 16]
| Violation
| The content of an RDF literal with an incoming http://www.opengis.net/ont/geosparql#asWKT[geo:asWKT] relation must conform to a well-formed WKT string, as defined by its official specification (Simple Features Access)
| 

|http://www.opengis.net/def/geosparql/validator/S17-gml-content[Shape 17]
| Violation
| The content of an RDF literal with an incoming http://www.opengis.net/ont/geosparql#asWKT[geo:asWKT] relation must conform to a well-formed WKT string, as defined by its official specification (Simple Features Access)
| 

|http://www.opengis.net/def/geosparql/validator/S18-geojson-content[Shape 18]
| Violation
| The content of an RDF literal with an incoming http://www.opengis.net/ont/geosparql#asGeoJSON[geo:asGeoJSON] relation must conform to a well-formed GeoJSON geometry string, as defined by its official specification
| 

|http://www.opengis.net/def/geosparql/validator/S19-kml-content[Shape 19]
| Violation
| The content of an RDF literal with an incoming http://www.opengis.net/ont/geosparql#asKML[geo:asKML] relation must conform to a well-formed KML geometry XML string, as defined by its official specification
| 

|http://www.opengis.net/def/geosparql/validator/S21-featureClass-hasGeometry[Shape 21]
| Violation
| A geo:Feature node (inferred or asserted) should have at least one outgoing http://www.opengis.net/ont/geosparql#hasGeometry[geo:hasGeometry] relation, or a specialization of it
| 

|http://www.opengis.net/def/geosparql/validator/S30-dimension-coordinateDimension[Shape 30]
| Violation
| If both geo:dimension and http://www.opengis.net/ont/geosparql#coordinateDimension[geo:coordinateDimension] properties are asserted, the value of http://www.opengis.net/ont/geosparql#dimension[geo:dimension] should be less than or equal to the value of geo:coordinateDimension
| 

|http://www.opengis.net/def/geosparql/validator/S32-geometryClass-hasGeometry-hasSerialization[Shape 32]
| Violation
| A http://www.opengis.net/ont/geosparql#Geometry[geo:Geometry] node (inferred or asserted) should always have at least one incoming http://www.opengis.net/ont/geosparql#hasGeometry[geo:hasGeometry] relation, or a specialization of it
| 

|http://www.opengis.net/def/geosparql/validator/S32-geometryClass-hasGeometry-hasSerialization[Shape 33a]
| Violation
| An instance of http://www.opengis.net/ont/geosparql#FeatureCollection[geo:FeatureCollection] should have at least one outgoing http://www.w3.org/2000/01/rdf-schema#member[rdfs:member] relation
| 

|Shape 33b
| Violation
| An instance of http://www.opengis.net/ont/geosparql#FeatureCollection[geo:FeatureCollection] should only have outgoing http://www.w3.org/2000/01/rdf-schema#member[rdfs:member] going to geo:Feature instances
| 

|Shape 34a
| Violation
| An instance of http://www.opengis.net/ont/geosparql#GeometryCollection[geo:GeometryCollection] should have at least one outgoing http://www.w3.org/2000/01/rdf-schema#member[rdfs:member] relation
| 

|Shape 34b
| Violation
| An instance of http://www.opengis.net/ont/geosparql#GeometryCollection[geo:GeometryCollection] should only have outgoing http://www.w3.org/2000/01/rdf-schema#member[rdfs:member] relations to http://www.opengis.net/ont/geosparql#Geometry[geo:Geometry] instances
| 

|Shape 35a
| Violation
| An instance of http://www.opengis.net/ont/geosparql#SpatialObjectCollection[geo:SpatialObjectCollection] should have at least one outgoing http://www.w3.org/2000/01/rdf-schema#member[rdfs:member] relation
| 

|Shape 35b
| Violation
| An instance of http://www.opengis.net/ont/geosparql#SpatialObjectCollection[geo:SpatialObjectCollection] should only have outgoing http://www.w3.org/2000/01/rdf-schema#member[rdfs:member] relations going to http://www.opengis.net/ont/geosparql#SpatialObject[geo:SpatialObject] instances, or subclasses of them
| 
|===
